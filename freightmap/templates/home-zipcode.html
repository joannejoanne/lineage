{% load staticfiles %}

<!DOCTYPE html>
<html>
  <head>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  

    <link rel="stylesheet" type="text/css" href="{% static "map/style.css" %}"/> 
    <script src="{% static "map/jquery-1.11.3.min.js" %}"> </script>


    <style type="text/css">


#states path {
  fill: #ccc;
  stroke: #fff;
}

path.arc {  
  pointer-events: none;
  fill: none;
  stroke: #000;
  display: none;
}


path.cell {
  fill: none;
  pointer-events: all;
}

circle {
  fill-opacity: .8;
  stroke: #fff;
}

#cells.voronoi path.cell {
  stroke: brown;
}

#cells g:hover path.arc {
  display: inherit;
}


.legend {
  font-size: 19px;
}

#origin {
  font-size: 19px;
}

rect {
  stroke-width: 2;
}

    </style>
  </head>
  <body>




    <h2>
      <span>U.S. Freight Data</span>, Lineage Logistics<br>
      <span2>Weight</span2>

      
    </h2>
 <!--        <div style="position:absolute;bottom:0;font-size:18px;">
        </div>
    <div id ="circlez"> </div> -->
    

<div class="segmented-control" id="button" style="width: 310px; color: #FFB6C1">
    <input type="radio" name="sb" id="sb-1" onclick="check_distance(this);">
     <input type="radio" name="sb" id="sb-2" onclick="check_time(this);">
    <input type="radio" name="sb" id="sb-3" checked onclick="check_weight(this);">
    <input type="radio" name="sb" id="sb-4" onclick="check_cube(this);">


    
    <label for="sb-1" data-value="Distance">Distance</label>  
    <label for="sb-2" data-value="Time">Time</label>  
    <label for="sb-3" data-value="Weight">Weight</label>
    <label for="sb-4" data-value="Volume">Volume</label>


</div>



<div id="infobox"> 


<div id="infobox-header"> &nbsp; </div>


<div id="allinfo" class="allinfo"> 
<div id="info"> &nbsp; 
</div>

</div>
</div>
    


    <script type="text/javascript" src="{% static "map/d3/d3.v2.js" %}"></script>
    <script type="text/javascript" src="{% static "map/d3/d3.csv.js" %}"></script>
    <script type="text/javascript" src="{% static "map/d3/d3.geo.js" %}"></script>
    <script type="text/javascript" src="{% static "map/d3/d3.geom.js" %}"></script> 

    <script type="text/javascript">

    var checked_option = "weight";

     function check_weight(button) {
      checked_option = "weight"; 
    
     }

      function check_cube(button) {
      checked_option = "totalcube";

     }

      function check_distance(button) {
      checked_option = "distance";

     }
       function check_time(button) {
      checked_option = "time";

     }


     var source, destination;

     function clear() {
              var infobox = document.getElementById("infobox"); 

        infobox.innerHTML = ""; 
     }

     clear(); 
     function set_header(origin) {

     
      var infobox_header = document.createElement('div');
                    infobox_header.setAttribute('id',"infobox-header");
                    infobox_header.innerHTML = "<br> <br> To " +  origin + " from...";
              document.getElementById("infobox").appendChild(infobox_header); 

     }



     function set_header_origin(origin) {




      var infobox_header = document.createElement('div');

      var mod_origin = origin.split('Origin-').join('');
      mod_origin = mod_origin.split('-').join(','); 
      mod_origin = mod_origin.split(',').join(', '); 
                    infobox_header.setAttribute('id',"infobox-header");
                    infobox_header.innerHTML = "<br> <br> From <b>" +  mod_origin + "</b> to... ";
              document.getElementById("infobox").appendChild(infobox_header); 

     }


     function set_header_dest(destination) {



      var infobox_header = document.createElement('div');
       var mod_dest = destination.split('Destination-').join('');
      mod_dest = mod_dest.split('-').join(','); 
      mod_dest = mod_dest.split(',').join(', '); 
                    infobox_header.setAttribute('id',"infobox-header");
                    infobox_header.innerHTML = "<br> <br> To <b>" +  mod_dest + "</b> from...";
              document.getElementById("infobox").appendChild(infobox_header); 

     }



//     function initialize(fromsource, todestination_list) {

//         var infobox = document.getElementById("infobox");     
        
//         //*********DIRECTIONS AND ROUTE**********************//
//             source = fromsource; 
//             // destination = "Los Angeles, CA"; 

//             // for (i = 0; i < todestination_list.length; i++) {

//             // destination = todestination_list[i]; 
//             //*********DISTANCE AND DURATION**********************//
//             var service = new google.maps.DistanceMatrixService();
//             service.getDistanceMatrix({
//                 origins: [source],
//                 // destinations: [destination],
//                 destinations: todestination_list, 
//                 travelMode: google.maps.TravelMode.DRIVING,
//                 unitSystem: google.maps.UnitSystem.METRIC,
//                 avoidHighways: false,
//                 avoidTolls: true
//             }, function (response, status) {

//                 if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                 

//                     // set_header(response.originAddresses[0] );

//                     // var infobox_header = document.createElement('div');
//                     // infobox_header.setAttribute('id',"infobox-header");
//                     // infobox_header.innerHTML = response.originAddresses[0] + " to ...";  


//                   for (i = 0; i < todestination_list.length; i++) {
//                     var distance = response.rows[0].elements[i].distance.text;
//                     var duration = response.rows[0].elements[i].duration.text;
        


//                      var dest_list = document.createElement('div');
//                     dest_list.setAttribute('id',"dest_list");
//                     dest_list.innerHTML = "<br> <b>" + response.destinationAddresses[i] + "</b>";  

                   
//                     // infobox.appendChild(infobox_header); 
//                     allinfo.appendChild(dest_list); 

//                     var info = document.createElement('div');
//                     info.innerHTML = "<div id='info'> Distance: <label id='distance'> " + distance + "</label> <br> Duration: <label id='duration'>" + duration + " </label> </div> ";   

//                     // infobox-header.setAttribute('id',"info");


//                     allinfo.appendChild(info); 


//                     // document.getElementById("distance").appendChild(distance); 
//                     // // document.getElementById("distance").innerHTML = distance; 
//                     // document.getElementById("duration").innerHTML = duration; 

//                     // var dvDistance = document.getElementById("dvDistance");
//                     // dvDistance.innerHTML = "";
//                     // dvDistance.innerHTML += "Distance: " + distance + "<br />";
//                     // dvDistance.innerHTML += "Duration:" + duration;
//                     // console.log(distance); 
//                     // console.log(duration);
//                     // console.log("distance = " + distance + " and duration = " + duration); 
//                     // document.getElementById("distance").innerHTML = distance;
//                     // document.getElementById("duration").innerHTML = duration; 
//                     }
//                   }
//                 // } else {
//                 //     alert("Unable to find the distance via road.");
//                 // }
//             });
      
// }


    function get_distance_duration(fromsource, todestination, count) {
      

//       $.when( { testing: 123 } ).done(function( x ) {
//   alert( x.testing ); // Alerts "123"
// });

  

       var individual_info = $(".info").get(count);


        //*********DIRECTIONS AND ROUTE**********************//
            source = fromsource; 
            // destination = "Los Angeles, CA"; 

            // for (i = 0; i < todestination_list.length; i++) {

            // destination = todestination_list[i]; 
            //*********DISTANCE AND DURATION**********************//
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [source],
                destinations: [todestination],
                // destinations: todestination_list, 
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: true
            }, function (response, status) {

                if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                 

                    // set_header(response.originAddresses[0] );
                     

                    // var infobox_header = document.createElement('div');
                    // infobox_header.setAttribute('id',"infobox-header");
                    // infobox_header.innerHTML = response.originAddresses[0] + " to ...";  


                  
                    var distance = response.rows[0].elements[0].distance.text;
                    var duration = response.rows[0].elements[0].duration.text;
        
                    var distance_stripped = distance.split(' km').join(''); 

                    //  var dest_list = document.createElement('div');
                    // dest_list.setAttribute('id',"dest_list");
                    // dest_list.innerHTML = "<br> <b>" + response.destinationAddresses[i] + "</b>";  

                   
                    // // infobox.appendChild(infobox_header); 
                    // allinfo.appendChild(dest_list); 

                

                    // infobox-header.setAttribute('id',"info");

                     
   function waitForElement(){
    if(typeof individual_info !== "undefined"){
        individual_info.innerHTML = individual_info.innerHTML + 
        "<br> Distance: <label id='distance'> " + distance_stripped + "</label> &nbsp;km  <br> Time: <label id='duration'>" + duration + " </label> </div> ";   


    }
    else{
        setTimeout(function(){
            waitForElement();
        },250);
    }
}

waitForElement(); 


                    

                 

                    // document.getElementById("distance").appendChild(distance); 
                    // // document.getElementById("distance").innerHTML = distance; 
                    // document.getElementById("duration").innerHTML = duration; 

                    // var dvDistance = document.getElementById("dvDistance");
                    // dvDistance.innerHTML = "";
                    // dvDistance.innerHTML += "Distance: " + distance + "<br />";
                    // dvDistance.innerHTML += "Duration:" + duration;
                    // console.log(distance); 
                    // console.log(duration);
                    // console.log("distance = " + distance + " and duration = " + duration); 
                    // document.getElementById("distance").innerHTML = distance;
                    // document.getElementById("duration").innerHTML = duration; 
                    }
                    // }
                // } else {
                //     alert("Unable to find the distance via road.");
                // }


            });



}











var color = d3.scale.ordinal()
    .domain(["Origin", "Destination"])
    .range(["white", "purple"]);


var w = 1200,
    h = 700;

var projection = d3.geo.azimuthal()
    .mode("equidistant")
    .origin([-98, 38])
    .scale(1400)
    .translate([640, 360]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").insert("svg:svg", "h2")
    .attr("width", w)
    .attr("height", h);

var states = svg.append("svg:g")
    .attr("id", "states");

var circles = svg.append("svg:g")
    .attr("id", "circles"); 
    

var rectangles = svg.append("svg:g")
    .attr("id", "rectangles"); 

var cells = svg.append("svg:g")
    .attr("id", "cells");

d3.select("input[type=checkbox]").on("change", function() {
  cells.classed("voronoi", this.checked);
});


// display outline of US states 
d3.json("{% static "map/us-states.json" %}", function(collection) {
  states.selectAll("path")
      .data(collection.features)
    .enter().append("svg:path")
      .attr("d", path);
});
  

d3.csv("{% static "map/paths_group.csv" %}", function(flights) { 
  var linksByOrigin = {},
      countByAirport = {},
      locationByAirport = {},
      positions = [],
      lineage = [];


  var arc = d3.geo.greatArc()
      .source(function(d) { return locationByAirport[d.source]; })
      .target(function(d) { return locationByAirport[d.target]; });

flights.forEach(function(flight) {
    var origin = flight.origin,
        destination = flight.destination,
        links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
        
    links.push({source: origin, target: destination});
    countByAirport[origin] = (countByAirport[origin] || 0) + 1;
    countByAirport[destination] = (countByAirport[destination] || 0) + 1;
  });

  d3.csv("{% static "map/REAL_DATA_ZIPCODEREGION.csv" %}", function(airports) {
    // Only consider airports with at least one flight.
    airports = airports.filter(function(airport) {
      if (countByAirport[airport.iata]) {
        var location = [+airport.longitude, +airport.latitude];
        locationByAirport[airport.iata] = location;
        positions.push(projection(location));
  var lineagecol = airport.lineage;
  lineage.push(lineagecol);
  return true;
      }
    });

// "32.7851-89.5064"  = iata of carthage 
// positions = [814.5041529530708, 479.7563608628291] 
    // = projection(locationByAirport["iata of carthage"])
// i 5395


    // Compute the Voronoi diagram of airports' projected positions.
    var polygons = d3.geom.voronoi(positions);
      


// console.log(d3.geom.voronoi(projection(locationByAirport["32.7851-89.5064"]))); 
// gives 

 function commaSeparateNumber(val){
    while (/(\d+)(\d{3})/.test(val.toString())){
      val = val.toString().replace(/(\d+)(\d{3})/, '$1'+','+'$2');
    }
    return val;
  }



  function sortByWeight() {
    // var info = document.getElementsByClassName('info').get(); 
    var $info = $("div[id^='allinfo']").get();

            // var count = $('#allinfo').length;
            // console.log(count); 

            // if (count == 1) {
            //   return;  
            // }


    
    var weight_div = $info.sort(function (a, b) {
        return parseInt($(a).find("#weight").text()) < parseInt($(b).find("#weight").text()) ? 1 : -1 ;

    })



      var infobox_header = document.getElementById("infobox-header").innerHTML; 

    
  
         $("#infobox").html(infobox_header);
    

    for (i = 0; i < weight_div.length; i++) {
    




         $("#infobox").append(weight_div);


    }
$('[id=weight]').css('color', 'red').css('font-weight', 'bold');



    


      
}

 function sortbyTotalCube() {
    // var info = document.getElementsByClassName('info').get(); 
    var $info = $("div[id^='allinfo']").get();

            // var count = $('#allinfo').length;
            // console.log(count); 

            // if (count == 1) {
            //   return;  
            // }


    
    var cube_div = $info.sort(function (a, b) {
        return parseInt($(a).find("#totalcube").text()) < parseInt($(b).find("#totalcube").text()) ? 1 : -1 ;

    })



      var infobox_header = document.getElementById("infobox-header").innerHTML; 

    
  
         $("#infobox").html(infobox_header);
    

    for (i = 0; i < cube_div.length; i++) {
    

         $("#infobox").append(cube_div);


    }
$('[id=totalcube]').css('color', 'red').css('font-weight', 'bold');

}



 function sortByDistance() {
    // var info = document.getElementsByClassName('info').get(); 
    var $info = $("div[id^='allinfo']").get();

            // var count = $('#allinfo').length;
            // console.log(count); 

            // if (count == 1) {
            //   return;  
            // }


    var distance_div = $info.sort(function (a, b) {
        
        
        console.log($(a).find("#distance")); 

        return parseInt($(a).find("#distance").text()) < parseInt($(b).find("#distance").text()) ? 1 : -1 ;

    })



      var infobox_header = document.getElementById("infobox-header").innerHTML; 

    
  
         $("#infobox").html(infobox_header);
    

    for (i = 0; i < distance_div.length; i++) {
    

         $("#infobox").append(distance_div);


    }
$('[id=distance]').css('color', 'red').css('font-weight', 'bold');
   
}



 function sortbyTime() {
    // var info = document.getElementsByClassName('info').get(); 
    var $info = $("div[id^='allinfo']").get();

            // var count = $('#allinfo').length;
            // console.log(count); 

            // if (count == 1) {
            //   return;  
            // }


    
    var time_div = $info.sort(function (a, b) {
        return parseInt($(a).find("#duration").text()) < parseInt($(b).find("#duration").text()) ? 1 : -1 ;

    })



      var infobox_header = document.getElementById("infobox-header").innerHTML; 

    
  
         $("#infobox").html(infobox_header);
    

    for (i = 0; i < time_div.length; i++) {
    

         $("#infobox").append(time_div);


    }
$('[id=duration]').css('color', 'red').css('font-weight', 'bold');
   
}







   function generate_info_zipcode(zipcoderegion, weight, totalcube, state) {
        
        var infobox = document.getElementById("infobox"); 

        var allinfo = document.createElement('div');
        allinfo.setAttribute('id', "allinfo"); 
        allinfo.setAttribute('class', "allinfo"); 

        
        var dest_list = document.createElement('div');
        dest_list.setAttribute('id',"dest_list");
        dest_list.innerHTML = "<br> Zipcode region:<b> " +  zipcoderegion + "xxx" + " </b>" + "&nbsp;&nbsp;&nbsp;(" + state +  ")"; 
                   
                    // infobox.appendChild(infobox_header); 
                    allinfo.appendChild(dest_list); 
                    var new_weight = (weight  / 2000).toFixed(2); 
                    new_weight = commaSeparateNumber(new_weight); 
                    var info = document.createElement('div');
                    info.innerHTML = "<div id='info' class='info'> Weight: <label id='weight'> " + new_weight + "</label>" + " tons" + "<br> Total cube: <label id='totalcube'>" + totalcube + " </label>" + "cm<sup>3</sup>" ;   
                    // infobox-header.setAttribute('id',"info");
                    allinfo.appendChild(info); 

                    infobox.appendChild(allinfo); 
                
  }




     var g = cells.selectAll("g")
        .data(airports)
      .enter().append("svg:g");


    function filterlist (destination_location) {
      return function(element) {
        if (element['iata'] == destination_location) {
          return element; 
        }

      }
    }



    function getdestname (destination_location) {
      return function(element) {

          if (element['iata'] == destination_location) {

          return element["name"]; 
        }
      }
    }





      var obj = {{ zipcodelist | safe }};

var all_zip_region = []; 
    g.append("svg:path")
        .attr("class", "cell")
        .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })
        .on("click", function(d, i) {  name = (d.name).replace(/\s+/g, '_'); 
                                        location.href = name; }) 
        .on("mouseover", function(d, i) { 


          var direction = "0k lbs inbound";
          if(lineage[i]==1) direction = "0k lbs outbound";
          d3.select("h2 span").text(d.name); 
          d3.select("h2 span2").text(countByAirport[d.iata] + direction); 

          // document.getElementById("infobox-header").innerHTML = d.name; 
          


            
      //       circles.selectAll("circle")
      //   .data(airports)
      // .enter().append("svg:circle")
      //   .attr("cx", function(d, i) { if (d.lineage == 1) return positions[i][0]; })
      //   .attr("cy", function(d, i) { if (d.lineage == 1) return positions[i][1]; })

      //   .attr("r", function(d, i) { return Math.sqrt(countByAirport[d.iata]/1.2); })
      //   .attr("fill", function(d, i) { if (d.lineage == 1) { return "steelblue"; } return "teal"; })
      //   .sort(function(a, b) { return countByAirport[a.iata] - countByAirport[b.iata]; });



          
            if (d.lineage == 1) {
             set_header_origin(d.name); 

            }
            else {
            set_header_dest(d.name); 
              }


          var dest_list_obj = linksByOrigin[d.iata]; 
          var dest_list = []; 
 
          
          for (i = 0; i < dest_list_obj.length; i++) {
            var destination_location = dest_list_obj[i].target; 
            var dest_lat = destination_location.substring(0, destination_location.indexOf('-'));
            
            var dest_lon = destination_location.substring(destination_location.indexOf('-'), destination_location.length - 1);
            var dest_name = dest_lat + ", " + dest_lon; 
            // dest_list.push(dest_name); 
      
            // console.log(airports.filter(getdestname(destination_location))); 
            var actual_dest_name = airports.filter(getdestname(destination_location))[0]; 
            
            var name = actual_dest_name.name.split(' ').join('');
            var hackedname = "#" + name; 

            svg.select(hackedname).style("fill", "red");
          


            // console.log(obj['11']);

            var actual_dest_info = airports.filter(filterlist(destination_location))[0]; 
            



            // console.log(airports); 
            // console.log(airports); 
            // console.log(dest_list_obj); 


            var zipcodereg = actual_dest_info['zipcoderegion']; 
   

            if (!(all_zip_region.indexOf(zipcodereg) > -1)) {

                
 
        

                generate_info_zipcode(zipcodereg, obj[zipcodereg].weight, obj[zipcodereg].totalcube, actual_dest_info['state'], i); 
                all_zip_region.push(zipcodereg); 
                 
            
          }

                get_distance_duration((d.latitude + ", " + d.longitude), dest_name, i);

          } 



          if (checked_option == "weight") {
    
            sortByWeight();
          

          }
          else if (checked_option == "totalcube") {
            sortbyTotalCube(); 
          }

          else if (checked_option == "time") {
            sortbyTime(); 
          }

          else if (checked_option == "distance") {
            
              
               sortByDistance(); 
  

            // sortByDistance(); 
          }


          // console.log(dest_list); 
          // initialize((d.latitude + ", " + d.longitude), "31.6948, -106.3"); 
          // initialize("Newport beach, CA", ["Phoeniz, AZ", "nYC, NY"]); 
          
          // initialize((d.latitude + ", " + d.longitude), dest_list);



        })

        .on("mouseout", function (d, i) {
          clear(); 
          all_zip_region = []; 
          circles.selectAll("circle").style("fill", "steelblue");
        });


    // console.log(countByAirport); 

    g.selectAll("path.arc")
        .data(function(d) { return linksByOrigin[d.iata] || []; })
      .enter().append("svg:path")
        .attr("class", "arc")
        .attr("stroke-width", function(d) { return countByAirport[d.target]/1000; } )
        .attr("d", function(d) { return path(arc(d)); });

    // g.selectAll("path.arc")
    //   .data(airports)
    //   .enter()
    //   .append("svg:path").attr("stroke-width", 3);


       rectangles.selectAll("rectangle")
        .data(airports)
      .enter().append("svg:rect")
        .attr("x", function(d, i) { if (d.lineage == 0) return positions[i][0]; })
        .attr("y", function(d, i) { if (d.lineage == 0) return positions[i][1]; })
        .attr('width', function(d, i) {  return Math.sqrt(countByAirport[d.iata]) * 1.3;})
        .attr('height', function(d, i) {return Math.sqrt(countByAirport[d.iata]) * 1.3;})
        .attr("id", function(d, i){ 
          var name = d.name.split(' ').join('');
           
          return name;  })
        .attr('fill', function(d, i) {return "purple";})
        .attr('fill-opacity', function(d, i) {return "0.4";})

  circles.selectAll("circle")
        .data(airports)
      .enter().append("svg:circle")
        .attr("cx", function(d, i) { if (d.lineage == 1) return positions[i][0]; })
        .attr("cy", function(d, i) { if (d.lineage == 1) return positions[i][1]; })
        .attr("id", function(d, i){ 
          var name = d.name.split(' ').join('');
          return name;  })
        .attr("r", function(d, i) { return Math.sqrt(countByAirport[d.iata]/1.2); })
        .attr("fill", function(d, i) { if (d.lineage == 1) { return "steelblue"; } return "teal"; })
        .sort(function(a, b) { return countByAirport[a.iata] - countByAirport[b.iata]; });



    rectangles.selectAll("rectangle")
  .data(airports)

  
    circles.selectAll("circle")
  .data(airports)



  // var legend = svg.selectAll("g.legend")
  //       .data(color.domain());
    
  // var legendEnter = legend.enter().append("g")
  //     .attr("class", "legend")
  //     .attr("transform", function(d, i) { return "translate(100," + i * 20 + ")"; });

  // legendEnter.append("rect")
  //     .attr("width", 18)
  //     .attr("height", 18)
  //     .attr("transform", function(d, i) { return "translate(100," + 630 + ")"; });
      
  // legendEnter.append("text")
  //     .attr("y", 9)
  //     .attr("dy", ".35em")
  //     .style("text-anchor", "end")
  //     .attr("transform", function(d, i) { return "translate(100," + 630 + ")"; });
      
  
  // legend.select("rect")
  //     .attr("x", 200 - 18)   
  //     .style("fill", color);        
      
  // legend.select("text")
  //     // proximity from key to value 
  //     .attr("x", 200 - 24)
  //     .text(function(d) { return d; });
  
  // legend.exit().remove();


  

                             
  });



  // var svgContainer = d3.select("#circlez").append("svg")
  //                                     .attr("width", 1000)
  //     .attr("height", 2000)
  //             .style("fill", "steelblue");        


  //  var circlez = svgContainer.append("circle")
  //                           .attr("cx", 232)
  //                           .attr("cy", 558)
  //                          .attr("r", 11);     


});
</script>



<!-- 
<div id="search_container"></div>
  <script type="text/template" id="search_template">
      <label>Search</label>
      <input type="text" id="search_input" />
      <input type="button" id="search_button" value="Search"/>
  </script>
 -->
<!-- 
    <script type="text/template" id="search_info"> 

    </script>
 -->



  </body>
</html>